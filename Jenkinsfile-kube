node("ci-node") {
    stage("checkout") {
        checkout scmGit(branches: [[name: "master"]], extensions: [], userRemoteConfigs: [[url: 'https://github.com/mchekini-check-consulting/staff-manager-api.git']])
    }

    // stage("build") {
    //     sh "chmod 777 mvnw"
    //     sh "./mvnw clean package -DskipTests=true"
    // }

    // stage("build image") {
    //     sh "sudo docker build -t staff-manager-api ."
    // }

    // stage("push docker image") {
    //     withCredentials([usernamePassword(credentialsId: 'mchekini', usernameVariable: 'username',
    //             passwordVariable: 'password')]) {
    //         sh "sudo docker login -u mchekini -p $password"
    //         sh "sudo docker tag staff-manager-api mchekini/staff-manager-api:$version"
    //         sh "sudo docker push mchekini/staff-manager-api:$version"
    //         sh "sudo docker rmi mchekini/staff-manager-api:$version"
    //         sh "sudo docker rmi staff-manager-api"
    //     }
    // }

    stage("deploy-to-k8s") {
       withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: "aws-user"]]) {
            sh "aws eks update-kubeconfig --region us-east-2 --name sm-cluster"
            sh "helm upgrade sm-api sm-api-chart --install --create-namespace --namespace staff-manager"
        } 
    }
}